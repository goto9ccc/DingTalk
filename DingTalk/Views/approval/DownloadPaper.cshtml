@{
    Layout = null;
}

<!--右侧实体内容-->
<el-main id="partPage" style="position:relative;">
    <div class="head-fixed" onclick="loadPage('/Main/approval')">
        <i class="el-icon-arrow-left"></i>
        下发图纸
    </div>

    <!--项目选择部分-->
    <template v-if="project.length == 0">
        <h4>选择项目</h4>
        <!--表格實體-->
        <el-table :data="tableData" stripe border>
            <el-table-column v-for="(value,key) in projectItems" :prop="key" :label="value" :key="key">
            </el-table-column>
            <el-table-column label="操作">
                <template slot-scope="scope">
                    <el-button v-on:click.native.prevent="selectProject(scope.$index, tableData)"
                               type="pirmary" size="small">
                        选择项目
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
        <!--底部翻頁-->
        <div style="text-align:right">
            <el-pagination v-on:size-change="handleSizeChange"
                           v-on:current-change="handleCurrentChange"
                           :current-page="currentPage"
                           :page-sizes="[1, 3, 5, 10]"
                           :page-size="5"
                           layout="total, sizes, prev, pager, next, jumper"
                           :total="totalRows">
            </el-pagination>
        </div>
    </template>
    <template v-else>
        <el-table :data="project" stripe border>
            <el-table-column v-for="(value,key) in projectItems" :prop="key" :label="value" :key="key">
            </el-table-column>
            <el-table-column label="操作">
                <template slot-scope="scope">
                    <el-button v-on:click.native.prevent="project = []"
                               type="pirmary" size="small">
                        重新选择
                    </el-button>
                </template>
            </el-table-column>
        </el-table>
    </template>

    <!--部件编辑部分-->
    <el-table :data="tableParts"
              style="width: 100%;margin-top:100px;">
        <el-table-column type="expand">
            <template slot-scope="props">
                <el-collapse accordion>
                    <el-collapse-item v-for="flow in props.row.flows" :key="flows.id">
                        <!--工序编辑部分-->
                        @*<template slot="title">
                            <span>工序名称：</span>
                            <el-button type="primary" plain size="mini">{{flow.name}}</el-button>
                            <el-button size="mini" v-on:click="deleteFlow()" type="danger" class="tableRight">删除工序</el-button>
                            <el-button size="mini" v-on:click="addWork()" class="tableRight">分配工作</el-button>
                        </template>*@
                        <el-form>
                            <el-form-item label="工序名称">
                                <el-input v-model="flow.name" prop="string"></el-input>
                            </el-form-item>
                            <el-form-item>
                                <el-button size="mini" v-on:click="addWork()" class="tableRight">分配工作</el-button>
                            </el-form-item>
                            <el-form-item>
                                <el-button size="mini" v-on:click="deleteFlow()" type="danger" class="tableRight">删除工序</el-button>
                            </el-form-item>
                        </el-form>
                        <!--工作分配部分-->
                        <el-form v-for="flow in flows.children" :key="flow.id" :inline="true" class="demo-form-inline form" size="mini">
                            <el-form-item label="执行人">
                                <el-input v-model="flow.label" :placeholder="flow.label" style="width:100px;"></el-input>
                            </el-form-item>
                            <el-form-item label="开始日期">
                                <el-date-picker v-model="flow.id"
                                                type="daterange"
                                                :picker-options="pickerOptions"
                                                range-separator="至"
                                                start-placeholder="开始日期"
                                                end-placeholder="结束日期">
                                </el-date-picker>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="danger" v-on:click="deleteWork">删除工作</el-button>
                            </el-form-item>
                        </el-form>
                    </el-collapse-item>
                </el-collapse>
            </template>
        </el-table-column>
        <el-table-column label="代号" prop="DrawingNo"></el-table-column>
        <el-table-column label="名称" prop="Name"></el-table-column>
        @*<el-table-column label="材料" prop="MaterialScience"></el-table-column>
        <el-table-column label="品牌" prop="Brand"></el-table-column>*@
        <el-table-column label="数量" prop="Count"></el-table-column>
        <el-table-column label="单位" prop="Unit"></el-table-column>
        <el-table-column label="类别" prop="Sorts"></el-table-column>
        <el-table-column label="备注" prop="Mark"></el-table-column>
        <el-table-column label="操作">
            <template slot-scope="scope">
                <el-button size="mini"
                           v-on:click="addFlow(scope.$index, scope.row)">
                添加工序</el-button>
            </template>
        </el-table-column>
    </el-table>
    <!--底部翻頁-->
    <div style="text-align:right">
        <el-pagination v-on:size-change="partsSizeChange"
                       v-on:current-change="partsCurrentChange"
                       :current-page="partsCurrentPage"
                       :page-sizes="[1, 3, 5, 10]"
                       :page-size="5"
                       layout="total, sizes, prev, pager, next, jumper"
                       :total="partsRows">
        </el-pagination>
    </div>

    <div>
        <el-button style="margin:40px 0 0 40%" type="primary"
                   v-on:click="addFlow">确定下发</el-button>
    </div>

</el-main>

<script>
    var demo = new Vue({
        el: "#partPage",
        mixins: [mixin],
        data: function () {
            return {
                //项目列表相关参数
                data: [],
                tableData: [],
                projectItems: {
                    ProjectId: '项目编号',
                    ProjectName: '项目名称',
                    ApplyMan: '创建人',
                    CreateTime: '创建时间',
                    DeptName: '所属部门'
                },
                totalRows: 0,
                project: [],
                //零件列表相关参数
                parts: [{
                    "id": 1,
                    "label": "一级 1",
                    "children": [{
                        "id": 4,
                        "label": "二级 1-1",
                        "children": [{
                            "id": 9,
                            "label": "三级 1-1-1"
                        }, {
                            "id": 10,
                            "label": "三级 1-1-2"
                        }]
                    }]
                }, {
                        "id": 2,
                        "label": "一级 2",
                        "children": [{
                        "id": 5,
                        "label": "二级 2-1"
                    }, {
                            "id": 6,
                            "label": "二级 2-2"
                    }]
                }, {
                        "id": 3,
                        "label": "一级 3",
                        "children": [{
                        "id": 7,
                        "label": "二级 3-1"
                    }, {
                        "id": 8,
                        "label": "二级 3-2"
                    }]
                    }],
                tableParts: [],
                partsRows: 0,
                partsCurrentPage: 1,
                partsPageSize: 5,

                ruleForm: {
                    name: '',
                    reson: '',
                }
            }
        },
        methods: {
            onSubmit() {
                console.log('submit!');
            },
            addFlow(index,row){

            },
            deleteFlow() {
                
            },
            addWork() {

            },
            deleteWork() {

            },
            //获取项目列表
            getProject() {
                var that = this
                $.ajax({
                    url: "/Project/GetAllProJect",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        console.log("获取项目列表")
                        console.log(data)
                        that.totalRows = data.length
                        that.data = data
                        that.getData()
                    },
                    error: function (err) {
                        console.log(err);
                    }
                })
            },
            //选择项目
            selectProject(index, data) {
                this.project.push(data[index])
                this.loadProject(data[index].ProjectId)
            },
            //加载项目信息
            loadProject(id) {
                var that = this
                $.ajax({
                    url: "/DrawingDown/GetDrawingDownInfo?ProjectId="+id+"&ApplyManId=123456",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        console.log("加载项目信息!-" + "/DrawingDown/GetDrawingDownInfo?ProjectId=" + id + "&ApplyManId=123456")
                        console.log(data)
                        that.partsRows = data.length
                        that.parts = data
                        that.getPartsData()
                    },
                    error: function (err) {
                        console.log(err);
                    }
                })
            },
            //部件列表翻页功能
            getPartsData() {
                console.log('get part data')
                var start = this.partsPageSize * (this.partsCurrentPage - 1)
                this.tableParts = this.parts.slice(start, start + this.partsPageSize)
            },
            partsSizeChange: function (val) {
                console.log('part size change')
                this.partsCurrentPage = 1
                this.partsPageSize = val
                this.getPartsData()
            },
            partsCurrentChange: function (val) {
                console.log('part current change')
                this.partsCurrentPage = val
                this.getPartsData()
            }
        },
        created: function () {
            this.getProject()
            loadHtml("mainPage", "partPage")
        }
    })


</script>



